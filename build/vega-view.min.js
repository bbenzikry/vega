!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-scenegraph"),require("d3-array"),require("vega-functions"),require("vega-runtime"),require("d3-timer")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-scenegraph","d3-array","vega-functions","vega-runtime","d3-timer"],t):t((e=e||self).vega={},e.vega,e.vega,e.vega,e.d3,e.vega,e.vega,e.d3)}(this,(function(e,t,n,i,r,a,s,o){"use strict";function u(e,t){e&&(null==t?e.removeAttribute("aria-label"):e.setAttribute("aria-label",t))}function l(e,n){var i=e._runtime.data;return t.hasOwnProperty(i,n)||t.error("Unrecognized data set: "+n),i[n]}function c(e,i){n.isChangeSet(i)||t.error("Second argument to changes must be a changeset.");var r=l(this,e);return r.modified=!0,this.pulse(r.input,i)}function h(e){var t=e.padding();return Math.max(0,e._viewWidth+t.left+t.right)}function d(e){var t=e.padding();return Math.max(0,e._viewHeight+t.top+t.bottom)}function f(e){var t=e.padding(),n=e._origin;return[t.left+n[0],t.top+n[1]]}function g(e,n,r){var a,s,o,u=e._renderer,l=u&&u.canvas();return l&&(o=f(e),s=n.changedTouches?n.changedTouches[0]:n,(a=i.point(s,l))[0]-=o[0],a[1]-=o[1]),n.dataflow=e,n.item=r,n.vega=function(e,n,i){var r=n?"group"===n.mark.marktype?n:n.mark.group:null;function a(e){var t,i=r;if(e)for(t=n;t;t=t.mark.group)if(t.mark.name===e){i=t;break}return i&&i.mark&&i.mark.interactive?i:{}}function s(e){if(!e)return i;t.isString(e)&&(e=a(e));for(var n=i.slice();e;)n[0]-=e.x||0,n[1]-=e.y||0,e=e.mark&&e.mark.group;return n}return{view:t.constant(e),item:t.constant(n||{}),group:a,xy:s,x:function(e){return s(e)[0]},y:function(e){return s(e)[1]}}}(e,r,a),n}const v={trap:!1};function p(e,n,i){const r=e._eventConfig&&e._eventConfig[n];return!(!1===r||t.isObject(r)&&!r[i])||(e.warn(`Blocked ${n} ${i} event listener.`),!1)}function _(e){return e.item}function m(e){return e.item.mark.source}function w(e){return function(t,n){return n.vega.view().changeset().encode(n.item,e)}}function y(e,t,n){var i=document.createElement(e);for(var r in t)i.setAttribute(r,t[r]);return null!=n&&(i.textContent=n),i}function b(e,n,i){if(n){var r=i.param,a=i.state;return a||(a=i.state={elements:null,active:!1,set:null,update:function(t){t!==e.signal(r.signal)&&e.runAsync(null,(function(){a.source=!0,e.signal(r.signal,t)}))}},r.debounce&&(a.update=t.debounce(r.debounce,a.update))),function(e,t,n,i){var r=y("div",{class:"vega-bind"});r.appendChild(y("span",{class:"vega-bind-name"},n.name||n.signal)),t.appendChild(r);var a=z;switch(n.input){case"checkbox":a=k;break;case"select":a=L;break;case"radio":a=C;break;case"range":a=x}a(e,r,n,i)}(a,n,r,e.signal(r.signal)),a.active||(e.on(e._signals[r.signal],null,(function(){a.source?a.source=!1:a.set(e.signal(r.signal))})),a.active=!0),a}}function z(e,t,n,i){var r=y("input");for(var a in n)"signal"!==a&&"element"!==a&&r.setAttribute("input"===a?"type":a,n[a]);r.setAttribute("name",n.signal),r.value=i,t.appendChild(r),r.addEventListener("input",(function(){e.update(r.value)})),e.elements=[r],e.set=function(e){r.value=e}}function k(e,t,n,i){var r={type:"checkbox",name:n.signal};i&&(r.checked=!0);var a=y("input",r);t.appendChild(a),a.addEventListener("change",(function(){e.update(a.checked)})),e.elements=[a],e.set=function(e){a.checked=!!e||null}}function L(e,t,n,i){var r=y("select",{name:n.signal}),a=n.labels||[];n.options.forEach((function(e,t){var n={value:e};S(e,i)&&(n.selected=!0),r.appendChild(y("option",n,(a[t]||e)+""))})),t.appendChild(r),r.addEventListener("change",(function(){e.update(n.options[r.selectedIndex])})),e.elements=[r],e.set=function(e){for(var t=0,i=n.options.length;t<i;++t)if(S(n.options[t],e))return void(r.selectedIndex=t)}}function C(e,t,n,i){var r=y("span",{class:"vega-bind-radio"}),a=n.labels||[];t.appendChild(r),e.elements=n.options.map((function(t,s){var o="vega-option-"+n.signal+"-"+t,u={id:o,type:"radio",name:n.signal,value:t};S(t,i)&&(u.checked=!0);var l=y("input",u);return l.addEventListener("change",(function(){e.update(t)})),r.appendChild(l),r.appendChild(y("label",{for:o},(a[s]||t)+"")),l})),e.set=function(t){for(var n=e.elements,i=0,r=n.length;i<r;++i)S(n[i].value,t)&&(n[i].checked=!0)}}function x(e,t,n,i){i=void 0!==i?i:(+n.max+ +n.min)/2;var a=null!=n.max?n.max:Math.max(100,+i)||100,s=n.min||Math.min(0,a,+i)||0,o=n.step||r.tickStep(s,a,100),u=y("input",{type:"range",name:n.signal,min:s,max:a,step:o});u.value=i;var l=y("label",{},+i);function c(){l.textContent=u.value,e.update(+u.value)}t.appendChild(u),t.appendChild(l),u.addEventListener("input",c),u.addEventListener("change",c),e.elements=[u],e.set=function(e){u.value=e,l.textContent=e}}function S(e,t){return e===t||e+""==t+""}function A(e,t,n,i,r,a){return(t=t||new i(e.loader())).initialize(n,h(e),d(e),f(e),r,a).background(e.background())}function E(e,t){return t?function(){try{t.apply(this,arguments)}catch(t){e.error(t)}}:null}function D(e,t){if("string"==typeof t){if("undefined"==typeof document)return e.error("DOM document instance not found."),null;if(!(t=document.querySelector(t)))return e.error("Signal bind element not found: "+t),null}if(t)try{t.innerHTML=""}catch(n){t=null,e.error(n)}return t}const R=e=>+e||0;function T(e){return t.isObject(e)?{top:R(e.top),bottom:R(e.bottom),left:R(e.left),right:R(e.right)}:(e=>({top:e,bottom:e,left:e,right:e}))(R(e))}async function O(e,n,r,a){const s=i.renderModule(n),o=s&&s.headless;return o||t.error("Unrecognized renderer type: "+n),await e.runAsync(),A(e,null,null,o,r,a).renderAsync(e._scenegraph.root)}var j={skip:!0};function H(e,t){var n=e.autosize(),i=e.padding();return t-(n&&"padding"===n.contains?i.left+i.right:0)}function U(e,t){var n=e.autosize(),i=e.padding();return t-(n&&"padding"===n.contains?i.top+i.bottom:0)}function M(e,n){return n.modified&&t.isArray(n.input.value)&&e.indexOf("_:vega:_")}function q(e,t){return!("parent"===e||t instanceof n.transforms.proxy)}function W(e,n,i,r){var a=e.element();a&&a.setAttribute("title",function(e){return null==e?"":t.isArray(e)?V(e):t.isObject(e)&&!t.isDate(e)?(n=e,Object.keys(n).map((function(e){var i=n[e];return e+": "+(t.isArray(i)?V(i):B(i))})).join("\n")):e+"";var n}(r))}function V(e){return"["+e.map(B).join(", ")+"]"}function B(e){return t.isArray(e)?"[…]":t.isObject(e)&&!t.isDate(e)?"{…}":e}function G(e,r){r=r||{},n.Dataflow.call(this),r.loader&&this.loader(r.loader),r.logger&&this.logger(r.logger),null!=r.logLevel&&this.logLevel(r.logLevel),this._el=null,this._elBind=null,this._renderType=r.renderer||i.RenderType.Canvas,this._scenegraph=new i.Scenegraph;var o=this._scenegraph.root;this._renderer=null,this._tooltip=r.tooltip||W,this._redraw=!0,this._handler=(new i.CanvasHandler).scene(o),this._preventDefault=!1,this._timers=[],this._eventListeners=[],this._resizeListeners=[],this._eventConfig=function(e){const n=t.extend({defaults:{}},e),i=(e,n)=>{n.forEach(n=>{t.isArray(e[n])&&(e[n]=t.toSet(e[n]))})};return i(n.defaults,["prevent","allow"]),i(n,["view","window","selector"]),n}(e.eventConfig);var u=function(e,t,i){var r=i||a.functionContext;return s.parse(t,s.context(e,n.transforms,r))}(this,e,r.functions);this._runtime=u,this._signals=u.signals,this._bind=(e.bindings||[]).map((function(e){return{state:null,param:t.extend({},e)}})),u.root&&u.root.set(o),o.source=u.data.root.input,this.pulse(u.data.root.input,this.changeset().insert(o.items)),this._width=this.width(),this._height=this.height(),this._viewWidth=H(this,this._width),this._viewHeight=U(this,this._height),this._origin=[0,0],this._resize=0,this._autosize=1,function(e){var t=e._signals,n=t.width,i=t.height,r=t.padding;function a(){e._autosize=e._resize=1}e._resizeWidth=e.add(null,(function(t){e._width=t.size,e._viewWidth=H(e,t.size),a()}),{size:n}),e._resizeHeight=e.add(null,(function(t){e._height=t.size,e._viewHeight=U(e,t.size),a()}),{size:i});var s=e.add(null,a,{pad:r});e._resizeWidth.rank=n.rank+1,e._resizeHeight.rank=i.rank+1,s.rank=r.rank+1}(this),function(e){e.add(null,t=>(e._background=t.bg,e._resize=1,t.bg),{bg:e._signals.background})}(this),function(e){var n=e._signals.cursor;n||(e._signals.cursor=n=e.add({user:"default",item:null})),e.on(e.events("view","mousemove"),n,(function(e,i){var r=n.value,a=r?t.isString(r)?r:r.user:"default",s=i.item&&i.item.cursor||null;return r&&a===r.user&&s==r.item?r:{user:a,item:s}})),e.add(null,(function(n){var i=n.cursor,r=this.value;return t.isString(i)||(r=i.item,i=i.user),function(e,t){const n=e.container();n&&(n.style.cursor=t)}(e,i&&"default"!==i?i:r||i),r}),{cursor:n})}(this),this.description(e.description),r.hover&&this.hover(),r.container&&this.initialize(r.container,r.bind)}var P=t.inherits(G,n.Dataflow);function I(e,n){return t.hasOwnProperty(e._signals,n)?e._signals[n]:t.error("Unrecognized signal name: "+t.stringValue(n))}function $(e,t){var n=(e._targets||[]).filter((function(e){var n=e._update;return n&&n.handler===t}));return n.length?n[0]:null}function N(e,t,n,i){var r=$(n,i);return r||((r=E(this,(function(){i(t,n.value)}))).handler=i,e.on(n,null,r)),e}function F(e,t,n){var i=$(t,n);return i&&t._targets.remove(i),e}P.evaluate=async function(e,t,i){if(await n.Dataflow.prototype.evaluate.call(this,e,t),this._redraw||this._resize)try{this._renderer&&(this._resize&&(this._resize=0,a=f(r=this),s=h(r),o=d(r),r._renderer.background(r.background()),r._renderer.resize(s,o,a),r._handler.origin(a),r._resizeListeners.forEach((function(e){try{e(s,o)}catch(e){r.error(e)}}))),await this._renderer.renderAsync(this._scenegraph.root)),this._redraw=!1}catch(e){this.error(e)}var r,a,s,o;return i&&n.asyncCallback(this,i),this},P.dirty=function(e){this._redraw=!0,this._renderer&&this._renderer.dirty(e)},P.description=function(e){if(arguments.length){const t=null!=e?e+"":null;return t!==this._desc&&u(this._el,this._desc=t),this}return this._desc},P.container=function(){return this._el},P.scenegraph=function(){return this._scenegraph},P.origin=function(){return this._origin.slice()},P.signal=function(e,t,n){var i=I(this,e);return 1===arguments.length?i.value:this.update(i,t,n)},P.width=function(e){return arguments.length?this.signal("width",e):this.signal("width")},P.height=function(e){return arguments.length?this.signal("height",e):this.signal("height")},P.padding=function(e){return arguments.length?this.signal("padding",T(e)):T(this.signal("padding"))},P.autosize=function(e){return arguments.length?this.signal("autosize",e):this.signal("autosize")},P.background=function(e){return arguments.length?this.signal("background",e):this.signal("background")},P.renderer=function(e){return arguments.length?(i.renderModule(e)||t.error("Unrecognized renderer type: "+e),e!==this._renderType&&(this._renderType=e,this._resetRenderer()),this):this._renderType},P.tooltip=function(e){return arguments.length?(e!==this._tooltip&&(this._tooltip=e,this._resetRenderer()),this):this._tooltip},P.loader=function(e){return arguments.length?(e!==this._loader&&(n.Dataflow.prototype.loader.call(this,e),this._resetRenderer()),this):this._loader},P.resize=function(){return this._autosize=1,this.touch(I(this,"autosize"))},P._resetRenderer=function(){this._renderer&&(this._renderer=null,this.initialize(this._el,this._elBind))},P._resizeView=function(e,t,n,i,r,a){this.runAfter((function(s){var o=0;s._autosize=0,s.width()!==n&&(o=1,s.signal("width",n,j),s._resizeWidth.skip(!0)),s.height()!==i&&(o=1,s.signal("height",i,j),s._resizeHeight.skip(!0)),s._viewWidth!==e&&(s._resize=1,s._viewWidth=e),s._viewHeight!==t&&(s._resize=1,s._viewHeight=t),s._origin[0]===r[0]&&s._origin[1]===r[1]||(s._resize=1,s._origin=r),o&&s.run("enter"),a&&s.runAfter(e=>e.resize())}),!1,1)},P.addEventListener=function(e,t,n){var i=t;return n&&!1===n.trap||((i=E(this,t)).raw=t),this._handler.on(e,i),this},P.removeEventListener=function(e,t){for(var n,i,r=this._handler.handlers(e),a=r.length;--a>=0;)if(i=r[a].type,n=r[a].handler,e===i&&(t===n||t===n.raw)){this._handler.off(i,n);break}return this},P.addResizeListener=function(e){var t=this._resizeListeners;return t.indexOf(e)<0&&t.push(e),this},P.removeResizeListener=function(e){var t=this._resizeListeners,n=t.indexOf(e);return n>=0&&t.splice(n,1),this},P.addSignalListener=function(e,t){return N(this,e,I(this,e),t)},P.removeSignalListener=function(e,t){return F(this,I(this,e),t)},P.addDataListener=function(e,t){return N(this,e,l(this,e).values,t)},P.removeDataListener=function(e,t){return F(this,l(this,e).values,t)},P.preventDefault=function(e){return arguments.length?(this._preventDefault=e,this):this._preventDefault},P.timer=function(e,t){this._timers.push(o.interval((function(t){e({timestamp:Date.now(),elapsed:t})}),t))},P.events=function(e,t,i){var r,a=this,s=new n.EventStream(i),o=function(n,i){a.runAsync(null,()=>{"view"===e&&function(e,t){var n=e._eventConfig.defaults,i=n.prevent,r=n.allow;return!1!==i&&!0!==r&&(!0===i||!1===r||(i?i[t]:r?!r[t]:e.preventDefault()))}(a,t)&&n.preventDefault(),s.receive(g(a,n,i))})};if("timer"===e)p(a,"timer",t)&&a.timer(o,t);else if("view"===e)p(a,"view",t)&&a.addEventListener(t,o,v);else if("window"===e?p(a,"window",t)&&"undefined"!=typeof window&&(r=[window]):"undefined"!=typeof document&&p(a,"selector",t)&&(r=document.querySelectorAll(e)),r){for(var u=0,l=r.length;u<l;++u)r[u].addEventListener(t,o);a._eventListeners.push({type:t,sources:r,handler:o})}else a.warn("Can not resolve event source: "+e);return s},P.finalize=function(){var e,t,n,i=this._tooltip,r=this._timers,a=this._eventListeners;for(e=r.length;--e>=0;)r[e].stop();for(e=a.length;--e>=0;)for(t=(n=a[e]).sources.length;--t>=0;)n.sources[t].removeEventListener(n.type,n.handler);return i&&i.call(this,this._handler,null,null,null),this},P.hover=function(e,t){return t=[t||"update",(e=[e||"hover"])[0]],this.on(this.events("view","mouseover",_),m,w(e)),this.on(this.events("view","mouseout",_),m,w(t)),this},P.data=function(e,i){return arguments.length<2?l(this,e).values.value:c.call(this,e,n.changeset().remove(t.truthy).insert(i))},P.change=c,P.insert=function(e,t){return c.call(this,e,n.changeset().insert(t))},P.remove=function(e,t){return c.call(this,e,n.changeset().remove(t))},P.scale=function(e){var n=this._runtime.scales;return t.hasOwnProperty(n,e)||t.error("Unrecognized scale or projection: "+e),n[e].value},P.initialize=function(e,t){const n=this,r=n._renderType,a=n._eventConfig.bind,s=i.renderModule(r);e=n._el=e?D(n,e):null,function(e){const t=e.container();t&&(t.setAttribute("role","figure"),u(t,e.description()))}(n),s||n.error("Unrecognized renderer type: "+r);const o=s.handler||i.CanvasHandler,l=e?s.renderer:s.headless;return n._renderer=l?A(n,n._renderer,e,l):null,n._handler=function(e,t,n,i){var r=new i(e.loader(),E(e,e.tooltip())).scene(e.scenegraph().root).initialize(n,f(e),e);return t&&t.handlers().forEach((function(e){r.on(e.type,e.handler)})),r}(n,n._handler,e,o),n._redraw=!0,e&&"none"!==a&&(t=t?n._elBind=D(n,t):e.appendChild(y("div",{class:"vega-bindings"})),n._bind.forEach((function(e){e.param.element&&"container"!==a&&(e.element=D(n,e.param.element))})),n._bind.forEach((function(e){b(n,e.element||t,e)}))),n},P.toImageURL=async function(e,n){e!==i.RenderType.Canvas&&e!==i.RenderType.SVG&&e!==i.RenderType.PNG&&t.error("Unrecognized image type: "+e);const r=await O(this,e,n);return e===i.RenderType.SVG?function(e,t){var n=new Blob([e],{type:t});return window.URL.createObjectURL(n)}(r.svg(),"image/svg+xml"):r.canvas().toDataURL("image/png")},P.toCanvas=async function(e,t){return(await O(this,i.RenderType.Canvas,e,t)).canvas()},P.toSVG=async function(e){return(await O(this,i.RenderType.SVG,e)).svg()},P.getState=function(e){return this._runtime.getState(e||{data:M,signals:q,recurse:!0})},P.setState=function(e){return this.runAsync(null,t=>{t._trigger=!1,t._runtime.setState(e)},e=>{e._trigger=!0}),this},e.View=G,Object.defineProperty(e,"__esModule",{value:!0})}));